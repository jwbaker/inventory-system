{% extends 'uw_inventory_system/base.html' %}
{% load uw_inventory_extras %}

{% block navbar_right %}
  <li>
    <button class="btn navbar-btn btn-success" id="pageSave" disabled="disabled">Save</button>
  </li>
  <li>
    <button class="btn navbar-btn btn-danger" id="pageCancel">Cancel</button>
  </li>
  {{ block.super }}
{% endblock navbar_right %}

{% block messages %}
   {{ block.super }}
    <div class="alert alert-warning hidden" 
         id="pageEditWarning" 
         role="alert">
      This page has unsaved changes
    </div>
{% endblock messages %}

{% block content %}
  <div class="row">
    <div class="col-xs-8 col-xs-offset-2">
      <div class="panel panel-default">
        <div class="panel-heading">Heading</div>
        <form action="{% url 'uw_inventory.views.inventory_save' inventory_item.id %}"
              method="post"
              id="itemForm">
          {% csrf_token %}
          {% show_editable_field inventory_item.name 'text' 'Name' %}
          {% show_static_field inventory_item.creation_date 'Creation Date' %}
          {% show_editable_field inventory_item.status 'dropdown' 'Status' %}
          {% show_editable_field inventory_item.purchase_price 'currency' 'Purchase Price' %}
          {% show_editable_field inventory_item.description 'textarea' 'Description' %}
        </form>
      </div>
    </div>
  </div>
{% endblock content %}

{% block js_includes %}
  {{ block.super }}
  {# Need this for the date formatting further down #}
  <script src="https://code.jquery.com/ui/1.11.2/jquery-ui.min.js"></script>

  <script type="text/javascript">
    {# Redirect on the cancel button #}
    $('#pageCancel').click(function(){
      window.location= '/list';
    });
    $('#pageSave').click(function(){
      $('form#itemForm').submit();
    });
  </script>
  <script type="text/javascript">
    var editClickHandler = function(context){
      var editTarget = context.attr('for');
      var paragraph = $('p#' + editTarget);
      paragraph.toggleClass('hidden');
      paragraph.siblings().toggleClass('hidden');
      editMenuToggle(editTarget);
    }

    var editMenuToggle = function(editTarget){
      {# We could have used a class rather than the for attribute, but this is more semantically meaningful #}
      $('i[for="' + editTarget + '"]').toggleClass('hidden');
    }

    $('.edit').click(function(){
      editClickHandler($(this));
    });

    $('.cancel').click(function(){
      editClickHandler($(this));
    });

    $('.save').click(function(){
      var paragraph = $('p#' + $(this).attr('for'));

      {# This line looks up from the pragraph for the parent div, then down for the input element #}
      var inputControl = paragraph.closest('div').find('.form-control');
      var original = inputControl.attr('data-default');
      var saveText; {# This will eventually go in the "saved" <p> tag text #}

      if(inputControl.is('select')){
        {# inputControl was formerly the select box itself, but we need the selected option #}
        inputControl = inputControl.find('option:selected');

        saveText = inputControl[0].text;
      } else if(inputControl.is('input[type="date"]')){
        {# Need to do this because sending the string alone into the Date constructor will #}
        {#   interpret the data as UTC, but we want it to be Eastern time #}
        var dateStr = inputControl[0].value;
        var dateArr = dateStr.split('-');
        var date = new Date(dateArr[0], dateArr[1] - 1, dateArr[2]);

        {# Keeps a consistent formatting on the date. We could do this with native JS, but this is cleaner #}
        saveText = $.datepicker.formatDate('M. d, yy', date);
      } else {
        {# We don't want to display placeholder text #}
        saveText = (inputControl[0].value == inputControl.placeholder ? '' : inputControl[0].value);
      }
      
      if(saveText !== original){ {# Have we made a change? #}
        $('#pageEditWarning').removeClass('hidden');
        $('#pageSave').removeAttr('disabled');
        inputControl.parents('div.form-group').addClass('list-group-item-warning');
      } else{ {# Are we back to original? #}
        $('#pageEditWarning').addClass('hidden');
        $('#pageSave').prop('disabled', 'disabled');
        inputControl.parents('div.form-group').removeClass('list-group-item-warning');
      }

      paragraph[0].textContent = saveText;

      editClickHandler($(this));
    });
  </script>
{% endblock js_includes %}