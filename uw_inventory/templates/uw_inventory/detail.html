{% extends 'uw_inventory/item_base.html' %}
{% load uw_forms_form_tags %}
{% load uw_forms_field_tags %}
{% load uw_forms_format_tags %}
{% load uw_inventory_model_tags %}
{% load uw_custom_field_field_tags %}

{% block gutter_nav %}
  {{ block.super }}
  {% if perms.uw_inventory.add_inventoryitem %}  
    <li class="list-group-item">
      <a href="{% url 'uw_inventory.views.inventory_copy' inventory_item.id %}">
        <i class="copy navigate" id="duplicate"></i> Duplicate
      </a>
    </li>
  {% endif %}
  {% if perms.uw_inventory.change_inventoryitem %}  
    <li class="list-group-item">
      {% if inventory_item.to_display %}
        <a href="{% url 'uw_inventory.views.inventory_delete' inventory_item.id %}">
          <i class="delete navigate fa-fw"></i> Delete
        </a>
      {% else %}
        <a href="{% url 'uw_inventory.views.inventory_undelete' inventory_item.id %}">
          <i class="restore navigate fa-fw"></i> Restore
        </a>
      {% endif %}
    </li>
  {% endif %}
{% endblock gutter_nav %}

{% block page_heading %}
  <span class="panel-title">{{ inventory_item.uuid }}</span>
  <span class="small pull-right">Last modified: {{ inventory_item.last_modified }}</span>
{% endblock page_heading %}

{% block page_body %}
  <form id="itemForm"
        method="post"
        action="{% url 'uw_inventory.views.inventory_detail' inventory_item.id %}"
        enctype="multipart/form-data">

    {% for key,fs in formsets.items %}
      {{ fs.management_form }}
    {% endfor %}

    <input type="number" id="scroll-position" name="scroll-position" class="persist-hidden" />

    <textarea name="custom_field_data" id="inputCustomFields" class="persist-hidden">{{ inventory_item.custom_field_data|default:'' }}</textarea>

    {% edit_form form perms.uw_inventory.change_inventoryitem shown_excluded_fields %}
    {% show_custom_fields inventory_item.custom_field_data %}

    {# Putting this template here makes me cry, but it works for now #}
    <div class="singleton-formset form-group list-group-item clearfix">
      <div class="col-xs-3">
        <label for="inputSopFile" class="control-label">SOP</label>
      </div>
      <div class="col-xs-8 field-container">
        <p class="form-control-static" id="inputSopFile">
          {% if formsets.sop.forms %}
            <a href="{% url 'uw_file_io.views.file_view' formsets.sop.forms.0.instance.file_field.name %}">
              {{ formsets.sop.forms.0.instance.get_name_display|filename }}
            </a>
          {% endif %}
        </p>

        <div class="hidden form-element" id="sop-form-container">
        {% if formsets.sop.forms %}
          {{ formsets.sop.forms.0.as_p }}
        {% else %}
          {{ formsets.sop.empty_form.as_p|prefix }}
        {% endif %}
        <input type="text" class="persist-hidden" id="file-description-default" value="{{ formsets.sop.forms.0.instance.description }}">
        </div>
      </div>
      {% if perms.uw_inventory.change_itemfile %}
        <div class="col-xs-1">
          <i class="save hidden" for="inputSopFile"></i>
          <i class="cancel hidden" for="inputSopFile"></i>
          <i class="edit" for="inputSopFile"></i>
        </div>
      {% endif %}
    </div>
    {% show_images formsets.image.forms perms.uw_inventory.view_deleted_itemimage %}

    {% show_files perms.uw_inventory.add_itemfile perms.uw_inventory.change_itemfile perms.uw_inventory.view_deleted_itemfile formsets.file %}

    {% show_comments formsets.comment.forms perms.uw_inventory.add_comment %}
  </form>
  {{ block.super }}
{% endblock page_body %}

{% block js_includes %}
  {{ block.super }}

  <script type="text/javascript">
    (function(){
      window.scrollTo(0, {{ scrollY }});
    })();
  </script>

  {% if perms.uw_inventory.change_inventoryitem %}
    <script type="text/javascript">
    {# An extra message if we're trying to duplicate with unsaved changes #}
    $("#duplicate").parent().click(function(){
      if(isPageDirty()){
        $('#confirmExitModal').find('.modal-body').append("<p>Unsaved changes will not be duplicated.</p>");
      }
    });
    </script>

    <script type="text/javascript">
      {# As with the paragraphs in the add page, it's easier to hide the form elements here than with Django #}
      $('.item-input').addClass('hidden');
    </script>

    <script type="text/javascript">
      {# This function performs all the magic of adding and removing edit states #}
      var editClickHandler = function(context){
        context.closest('.form-group').find('.field-container').children().toggleClass('hidden');
        context.parent().children().toggleClass('hidden');
      }

      var editMenuToggle = function(editTarget){
        {# We could have used a class rather than the for attribute, but this is more semantically meaningful #}
        $('i[for="' + editTarget + '"]').toggleClass('hidden');
        $('.form-element#' + editTarget).focus(); {# Autofocus for usability goodness #}
      }

      $('.singleton-field,.singleton-formset .edit').click(function(){
        editClickHandler($(this));
      });

      $('.singleton-field,.singleton-formset .cancel').click(function(){
        editClickHandler($(this));
      });

      $('.singleton-field .save').click(function(){
        var saveText;
        var hasChanged = false;

        var formGroup = $(this).closest('.form-group');
        var originalValue = formGroup.find('input.default-value').val();
        var savedParagraph = formGroup.find('p.form-control-static');
        var inputControl = savedParagraph.siblings('.form-element');

        if(inputControl.is('select')){
          {# inputControl was formerly the select box itself, but we need the selected option #}
          var selectedOptions = inputControl.find('option:selected');
          if(inputControl.is('select[multiple="multiple"]')){
            saveText = '';
            for (var i = 0; i < selectedOptions.length; i++) {
              saveText += selectedOptions[i].value;

              if(i !== selectedOptions.length - 1) saveText += ', ';
            }
          } else{
            saveText = inputControl.text();
          }
        } else if(inputControl.is('input[type="date"]')){
          {# Need to do this because sending the string alone into the Date constructor will #}
          {#   interpret the data as UTC, but we want it to be Eastern time #}
          var dateStr = inputControl.val();
          if(dateStr){
            var dateArr = dateStr.split('-');
            var date = new Date(dateArr[0], dateArr[1] - 1, dateArr[2]);

            {# Keeps a consistent formatting on the date. We could do this with native JS, but this is cleaner #}
            saveText = $.datepicker.formatDate('M. d, yy', date);
          } else{
            saveText = '';
          }
        } else if(inputControl.is('i.checkbox-2')){
          saveText = (inputControl.hasClass('checked') ? 'Yes' : 'No');
        } else if(inputControl.is('.ui-autocomplete-input')){
          saveText = (inputControl[0].value == inputControl.placeholder ? '' : inputControl[0].value);
          var toSave;
          if(saveText === ''){
            toSave = '';
          } else {
            toSave = inputControl.attr('to-save');
          }
          {# More magic here, because the autocomplete widget sends the name value but we need the id #}
          inputControl[1].setAttribute('value', toSave);
        } else if(inputControl.is('div.checkboxes')){
          var selectedOptions = inputControl.find('[type=checkbox]:checked, [type=radio]:checked');
          if(selectedOptions.length > 1){
            saveText = '';
            for (var i = 0; i < selectedOptions.length; i++) {
              saveText += selectedOptions[i].value;

              if(i !== selectedOptions.length - 1) saveText += ', ';
            }
          } else if(selectedOptions.length == 1){
            saveText = selectedOptions[0].value
          }
        } else {
          saveText = (inputControl.val() == inputControl.placeholder ? '' : inputControl.val());
        }

        hasChanged = (saveText !== originalValue) {# Here, blank values are considered a change #}

        if(hasChanged){ {# Have we made a change? #}
          formGroup.addClass('list-group-item-warning has-warning');
        } else{ {# Are we back to original? #}
          formGroup.removeClass('list-group-item-warning has-warning');
        }
        $(window).trigger('pagechanges', hasChanged); {# Here's that event from earlier #}

        savedParagraph.text(saveText);

        if(inputControl.parent().is('.custom-field-container')){
          var custom_field_json = JSON.parse($('textarea#inputCustomFields').val() || '{}');
          custom_field_json[inputControl.parent().attr('id')]['value'] = saveText;
          $('textarea#inputCustomFields').val(JSON.stringify(custom_field_json));
        }

        editClickHandler($(this));
      });

      $('.singleton-formset .save').click(function(){
        var saveText; {# This will eventually go in the "saved" <p> tag text #}
        var hasChanged = false;

        var formGroup = $(this).closest('.form-group');
        var originalValue = formGroup.find('input.default-value').val();
        var savedParagraph = formGroup.find('p.form-control-static');
        var inputControl = savedParagraph.siblings('.form-element');

        var new_file_name = inputControl.find('[type="file"]').val();
        if(new_file_name) new_file_name = new_file_name.formatFilename();
        var new_description = inputControl.find('#inputDescription').val();

        saveText = new_description || new_file_name || savedParagraph.text().trim();
        hasChanged = (new_file_name !== '') ||
                     (new_description !== inputControl.find('#file-description-default').attr('value'));

        if(hasChanged){ {# Have we made a change? #}
          inputControl.parents('div.form-group').addClass('list-group-item-warning has-warning');
        } else{ {# Are we back to original? #}
          inputControl.parents('div.form-group').removeClass('list-group-item-warning has-warning');
        }
        $(window).trigger('pagechanges', hasChanged); {# Here's that event from earlier #}

        savedParagraph.text(saveText);

        editClickHandler($(this));
      });
    </script>
  {% endif %}
{% endblock js_includes %}
