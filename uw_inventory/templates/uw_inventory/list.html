{% extends 'uw_inventory_system/base.html' %}
{% load uw_inventory_misc_tags %}

{% block css_includes %}
  <!-- DataTables -->
  <link rel="stylesheet" href="http://cdn.datatables.net/1.10.4/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="http://cdn.datatables.net/plug-ins/3cfcc339e89/integration/bootstrap/3/dataTables.bootstrap.css">

  <style type="text/css">
    {# Make the whole row look clickable #}
    table#inventoryTable tbody tr:hover{
      cursor: pointer;
    }
    td.sop-cell{
      text-align: center;
    }
  </style>
{% endblock css_includes %}

{% block navbar_right %}
  {{ block.super }}
{% endblock navbar_right %}

{% block content %}
  <div class="row">
    <table id="inventoryTable" class="table table-condensed table-hover">
      <thead>
        {# There should be a better way to generate this table, but this will do for now #}
        <td>
          <div class="header-label">
            SOP
            <i class="fa filter"></i>
          </div>
          <div class="header-filter">
            <i class="fa fa-2x checkbox" data-col-index="0"></i>
          </div>
        </td>
        <td>
          <div class="header-label">
            Name
            <i class="fa filter"></i>
          </div>
          <div class="header-filter">
            <input type="text" class="form-control input-sm" data-col-index="1" />
          </div>
        </td>
        <td>
          <div class="header-label">
            Location
            <i class="fa filter"></i>
          </div>
          <div class="header-filter">
            <input type="text" class="form-control input-sm" data-col-index="2" />
          </div>
        </td>
        <td>
          <div class="header-label">
            Technician
            <i class="fa filter"></i>
          </div>
          <div class="header-filter">
            <input type="text" class="form-control input-sm" data-col-index="3" />
          </div>
        </td>
        <td>
          <div class="header-label">
            Owner
            <i class="fa filter"></i>
          </div>
          <div class="header-filter">
            <input type="text" class="form-control input-sm" data-col-index="4" />
          </div>
        </td>
        <td>
          <div class="header-label">
            Manufacturer
            <i class="fa filter"></i>
          </div>
          <div class="header-filter">
            <input type="text" class="form-control input-sm" data-col-index="5" />
          </div>
        </td>
        <td>
          <div class="header-label">
            Model
            <i class="fa filter"></i>
          </div>
          <div class="header-filter">
            <input type="text" class="form-control input-sm" data-col-index="6" />
          </div>
        </td>
        <td>Description</td>
        <td>Technician</td>
        <td>Owner</td>
        <td>Technician ID</td>
        <td>Status</td>
        <td>Serial Number</td>
        <td>Manufacture Date</td>
        <td>Purchase Price</td>
        <td>Purchase Date</td>
        <td>Replacement Cost</td>
        <td>Replacement Cost Estimation Date</td>
        <td>CSA Required?</td>
        <td>Factory CSA?</td>
        <td>CSA Special Required?</td>
        <td>CSA Special Certification Date</td>
        <td>Modified Since CSA?</td>
        <td>Available for Undergraduate?</td>
        <td>CSA Cost</td>
        <td>SOP Required?</td>
        <td>Lifting Device?</td>
        <td>Lifting Device Inspection Date</td>
        <td>Comments</td>
      </thead>
      <tbody>
        {% for item in inventory_list %}
          {% if item.to_display or perms.uw_inventory.view_deleted_item %}
            <tr {% if not item.to_display %}class="disabled"{% endif %}>
              <td class="sop-cell">
                {% if item.sop_file %}
                  <a href="{% url 'uw_inventory_system.views.file_view' item.sop_file.file_field.name %}">
                    {% contexual_file_icon item.sop_file %}
                  </a>
                {% endif %}
              </td>
              <td>
                {# Have to put the link somewhere #}
                <a class="item-detail" href="{% url 'uw_inventory.views.inventory_detail' item.id %}"></a>
                {{ item.name }}
              </td>
              <td>{{ item.location }}</td>
              <td>{{ item.technician.get_name_display }}</td>
              <td>{{ item.owner.get_name_display }}</td>
              <td>{{ item.manufacturer }}</td>
              <td>{{ item.model_number }}</td>
              <td>{{ item.description }}</td>
              <td>{{ item.technician }}</td>
              <td>{{item.owner }}</td>
              <td>{{ item.tech_id }}</td>
              <td>{{ item.get_status_display }}</td>
              <td>{{ item.serial_number }}</td>
              <td>{{ item.manufacture_date }}</td>
              <td>{{ item.purchase_price }}</td>
              <td>{{ item.purchase_date }}</td>
              <td>{{ item.replacement_cost }}</td>
              <td>{{ item.replacement_cost_date }}</td>
              <td>{{ item.csa_required }}</td>
              <td>{{ item.factory_csa }}</td>
              <td>{{ item.csa_special }}</td>
              <td>{{ item.csa_special_date }}</td>
              <td>{{ item.modified_since_csa }}</td>
              <td>{{ item.undergraduate }}</td>
              <td>{{ item.csa_cost }}</td>
              <td>{{ item.sop_required }}</td>
              <td>{{ item.lifting_device }}</td>
              <td>{{ item.lifting_device_inspection_date }}</td>
              <td>{{ item.get_comments_as_string }}</td>
            </tr>
          {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock content %} 

{% block js_includes %}
  <script type="text/javascript">
    $('.header-filter').addClass('hidden').on('click', function(e){e.stopPropagation()});

    $('.header-label').click(function(e){
      e.stopPropagation();
      $('.header-label i').removeClass('text-primary');
      $('.header-filter').addClass('hidden');

      var cell = $(this).closest('td');
      cell.find('.header-filter').removeClass('hidden');
      $(this).find('i').addClass('text-primary');
    });
  </script>

  <!-- DataTables -->
  <script src="http://cdn.datatables.net/1.10.4/js/jquery.dataTables.min.js"></script>
  <script src="http://cdn.datatables.net/plug-ins/3cfcc339e89/integration/bootstrap/3/dataTables.bootstrap.js"></script>

  <script type="text/javascript">
    var dataTable = $('table#inventoryTable').DataTable({
        {# This is how we can search on invisible columns - DataTables magic! #}
        'columnDefs': [
          {
            {# Horrible, hardcoded magic... #}
            'targets': [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28],
            'visible': false,
          }
        ]
      });
  </script>
  <script type="text/javascript">
    {# If we click anywhere in a row, we want to trigger the link contained in that row #}
    $('tbody tr').click(function(){
      window.location = $(this).find('a.item-detail').attr('href');
    });
  </script>

  <script type="text/javascript">
    $('.checkbox').click(function(e){
      if($(this).hasClass('unchecked')){
        $(this).removeClass('unchecked');
      } else if($(this).hasClass('checked')){
        $(this).removeClass('checked').addClass('unchecked');
      } else{
        $(this).addClass('checked');
      }

      $('#inventoryTable').trigger('filter', [$(this).attr('data-col-index'), undefined])
    });

    $('.header-filter input').on('input propertychange past', function(e){
      $('#inventoryTable').trigger('filter', [$(this).attr('data-col-index'), $(this).val()])
    });

    $('#inventoryTable').on('filter', function(event, columnIndex, filter_value){
      switch(columnIndex){
        case 0:
          break;
        default:
          dataTable.columns(columnIndex).search(filter_value).draw(); break;
      }
    });
  </script>
{% endblock js_includes %}