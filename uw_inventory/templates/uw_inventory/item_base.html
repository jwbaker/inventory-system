{% extends 'uw_forms/form_base.html' %}
{% load uw_inventory_modal_tags %}
{% load uw_inventory_model_tags %}
{% load uw_forms_form_tags %}

{% block css_includes %}
  <style type='text/css'>
    .ui-autocomplete {
      max-height: 100px;
      overflow-y: auto;
      /* prevent horizontal scrollbar */
      overflow-x: hidden;
    }
    img.disabled {
      opacity: 0.4;
      filter: alpha(opacity=40); /* for IE */
    }
  </style>
  <!-- jQuery UI theme for the autocomplete widget -->
  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/smoothness/jquery-ui.min.css">
{% endblock css_includes %}

{% block page_body %}
{% endblock page_body %}

{% block modal %}
  {% confirm_modal 'Exit' %}

  {# There must be a better way to do modals... #}
  <div class="modal fade" id="autocompleteAddTermModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title"></h4>
        </div>
        <div class="modal-body">
          <form id="autocompleteAddTermForm">
            {% csrf_token %}
            <div class="form-group">
              <label for="termName">Name<span class="text-danger">*</span></label>
              <input type="text"
                     class="form-control"
                     id="autocompleteAddTermName"
                     name="termName"
                     placeholder="Name" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="autocompleteAddTermSubmit">Add option</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <div class="modal fade" id="autocompleteAddUserTermModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title"></h4>
        </div>
        <div class="modal-body">
          <form id="autocompleteAddUserTermForm">
            {% csrf_token %}
            <div class="form-group">
              <label for="termName">UW ID<span class="text-danger">*</span></label>
              <input type="text"
                     class="form-control"
                     id="autocompleteAddUserTermName"
                     name="termName"
                     placeholder="UW ID" />
            </div>
            <div class="form-group">
              <label for="termFirstName">First name</label>
              <input type="text"
                     class="form-control"
                     id="autocompleteAddUserTermFirstNamee"
                     name="termFirstName"
                     placeholder="First name" />
            </div>
            <div class="form-group">
              <label for="termLastName">Last Name</label>
              <input type="text"
                     class="form-control"
                     id="autocompleteAddUserTermLastName"
                     name="termLastName"
                     placeholder="Last Name" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="autocompleteAddUserTermSubmit">Add option</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
{% endblock modal %}

{% block js_includes %}
  {# Need this for the date formatting on Edit page and for autocomplete widgets #}
  <script src="https://code.jquery.com/ui/1.11.2/jquery-ui.min.js"></script>

  {{ block.super }}

  <script type="text/javascript">
    /*
     * Formats a file path into an absolute filename
     */
    String.prototype.formatFilename = function(){
      try{
        {# This annoyingly complicated regex basically takes anything that's not a '\', #}
        {# followed by a '.', followed by literally anything. It's a naive way to do the job, #}
        {# since it precludes the possibility of having '.' in filenames, but it's good enough for now #}
        return this.match(/[^\\]*\..*/)[0];
      } catch(e){
        return '';
      }
    }
  </script>

  <script type="text/javascript">
    {# It's a little messy, but this will allow us to disable files from displaying #}
    $('[for*=to_display]').addClass('persist-hidden');
    $('[name*=to_display]').addClass('persist-hidden');
  </script>

  <script type="text/javascript">
    var stringToFilesize = function(str){
      var components = str.split(/\s/);
      var numComponent = parseFloat(components[0]);

      switch(components[1]){
        case 'GB':
          numComponent *= 1000000000; break;
        case 'MB':
          numComponent *= 1000000; break;
        case 'KB':
          numComponent *= 1000; break;
      }

      return numComponent;
    }
  </script>

  <script type="text/javascript">
    $('.sort-row').click(function(){
      var rows = $(this).closest('table').find('tr.file-row');
      var sortColumnIndex = parseInt($(this).attr('data-index'), 10);
      var compareDelta = $(this).hasClass('sort-asc') ? -1 : 1;

      $(this).closest('table').find('tr.file-row').remove();
      rows = rows.sort(function(a, b){
        var aCompare = $(a).children()[sortColumnIndex].textContent.trim();
        var bCompare = $(b).children()[sortColumnIndex].textContent.trim();

        if($(rows.children()[sortColumnIndex]).hasClass('file-size')){
          aCompare = stringToFilesize(aCompare);
          bCompare = stringToFilesize(bCompare);
        }

        if(aCompare < bCompare){
          return -1 * compareDelta;
        } else if(aCompare > bCompare){
          return 1 * compareDelta;
        }
        return 0;

      });

      $('#file-table tbody').append(rows);

      $('#file-table').find('.sort-row').removeClass('sort-asc').removeClass('sort-desc')
                                        .removeClass('text-primary').addClass('sort');

      $(this).addClass('text-primary');
      if(compareDelta > 0){
        $(this).removeClass('sort');
        $(this).addClass('sort-asc');
      } else {
        $(this).removeClass('sort');
        $(this).addClass('sort-desc');
      }
    });
  </script>

  {% if perms.uw_inventory.add_autocompletedata %}
    <script type="text/javascript">
      {# Launch the modal to add an autocomplete term #}
      $('a.autocomplete-add-term').click(function(event){
        var dataSet = event.target.getAttribute('data-set');
        var targetID;

        switch(dataSet){
          case 'technician': case 'owner':
            targetID = 'autocompleteAddUserTerm'; break;
          default:
            targetID = 'autocompleteAddTerm'; break;
        }

        $('#' + targetID + 'Submit').attr('data-set', dataSet);

        {# Because we're using one modal to add items to all autocomplete fields, #}
        {# we clear the modal between 'sessions' #}
        $('#' + targetID + 'Name').val('');

        {# We also have to set some of the modal's content dynamically #}
        $('#' + targetID + 'Modal').find('.modal-title')[0].textContent = "Add new " + dataSet;
        $('#' + targetID + 'Modal').modal('show');
        $('#' + targetID + 'Name').focus();
      });

      var addAutocompleteTermAjax = function(targetID){
        $('span.error').remove();
        $('#' + targetID + 'Name').parent().removeClass('has-error');

        var dataSet = $('#' + targetID + 'Submit').attr('data-set');

        if(dataSet === 'owner' || dataSet === 'technician'){
          dataSet = 'user'
        }
        var optionName = $('#' + targetID + 'Name').val();
        if(optionName){
          $.ajax({
            url: '{% url "uw_inventory.views.autocomplete_new" %}',
            type: 'POST',
            data: $('#' + targetID + 'Form').serialize() + "&dataSet=" + dataSet,
            success: function(data){
              if(data.error){
                $('#' + targetID + 'Name').parent().addClass('has-error');
                $('#' + targetID + 'Name').parent().append(
                  '<span class="error text-danger">'+ data.error +'</span>'
                );
              } else {
                $('#' + targetID + 'Submit').removeAttr('data-set');
                $('#' + targetID + 'Modal').modal('hide');
              }
            },
            error: function(xhr, err_msg, err){
              console.log(xhr);
              console.log(err_msg);
              console.log(err);
            }
          });
        } else {
          $('#' + targetID + 'Name').parent().append(
            '<span class="error text-danger">This field is required</span>'
          );
          $('#' + targetID + 'Name').parent().addClass('has-error');
        }
      }

      {# Submit a new autocomplete term #}
      $('#autocompleteAddTermSubmit').click(function(event){
        addAutocompleteTermAjax('autocompleteAddTerm');
      });
      $('#autocompleteAddUserTermSubmit').click(function(event){
        addAutocompleteTermAjax('autocompleteAddUserTerm');
      });
    </script>
  {% endif %}

  <script type="text/javascript">
    $('.file-download').click(function(){
      console.log($(this).attr('data-target'))
      window.location = $(this).attr('data-target');
    });
  </script>

  {% if perms.uw_inventory.add_comment %}
    <script type="text/html" id="comment-template">
      <div class="row comment">
        <div id="comment-__prefix__" class="col-xs-11">
          {{ formsets.comment.empty_form.as_p }}
        </div>
        <div class="col-xs-1">
          <i class="save"></i>
          <i class="cancel"></i>
          <i class="delete"></i>
        </div>

        <div class="col-xs-11 hidden static-comment">
          {% include 'uw_inventory/comment_detail.html' %}
        </div>
        <div class="col-xs-1 hidden">
          <i class="edit"></i>
          <i class="delete"></i>
        </div>
      </div>
    </script>

    <script type="text/javascript">
      $('#add-comment').click(function(){
        var count = $('#id_comments-TOTAL_FORMS').val();
        var template = $('#comment-template').html().replace(/__prefix__/g, count);
        $('#id_comments-TOTAL_FORMS').val(parseInt(count)+1);

        var newElement = $(template).prependTo('#comments-list');

        newElement.find('[id*=creation_date]').parent().addClass('persist-hidden');

        newElement.find('[id*=author]').val({{ user.id }});
        newElement.find('[id*=author]').parent().addClass('persist-hidden');

        newElement.find('[id*=DELETE]').parent().addClass('persist-hidden');
      });

      $('#comments-list').on('click', 'i.save', function(){
        var comment = $(this).closest('.comment');

        var newcommentJSON = {
          'body': comment.find('#inputBody').val(),
          'author': '{{ user.get_name_display }}',
          'creation_date': comment.find('[id*=creation_date]').val(),
        }

        var staticcomment = comment.find('.static-comment');
        staticcomment.find('.panel-heading small strong')[0].textContent = newcommentJSON.author;
        staticcomment.find('.panel-heading small em')[0].textContent = newcommentJSON.creation_date;
        staticcomment.find('.panel-body')[0].textContent = newcommentJSON.body;

        comment.children().toggleClass('hidden');
        $(window).trigger('pagechanges', true);
      });

      $('#comments-list').on('click', 'i.cancel', function(){
        if(!$(this).closest('.comment').find('#inputBody').val()){
          $(this).siblings('i.delete').click();
        } else {
          $(this).closest('.comment').children().toggleClass('hidden');
        }
      });

      $('#comments-list').on('click', 'i.delete', function(){
        var comment = $(this).closest('.comment');

        comment.find('[id*=DELETE]').attr('checked', 'checked');
        comment.addClass('hidden');
      });

      $('#comments-list').on('click', 'i.edit', function(){
        $(this).closest('.comment').children().toggleClass('hidden');
      });
    </script>
  {% endif %}

  {% if perms.uw_inventory.add_itemfile %}
    <script type="text/html" id="file-template">
      <div id="file-__prefix__">
        {{ formsets.file.empty_form.as_p }}
      </div>     
    </script>

    <script type="text/javascript">
      (function(){
        {# We need to set these management form fields manually because we're using the same #}
        {# formset factory for files as for SOP #}
        $('#id_sop-TOTAL_FORMS').val(1);
        $('#id_sop-MAX_NUM_FORMS').val(1);
      })();
    </script>

    <script type="text/html" id="file-table-row-template">
      <tr class="file-row">
        {# When we toggle visibility on the tr's children, the hidden classes will all swap #}
        <td class="hidden file-description"></td>
        <td class="hidden file-size"></td>
        <td class="hidden">
          <i class="file-edit"></i>
          <i class="delete"></i>
        </td>
        <td colspan="2">__form__</td>
        <td>
          <i class="save"></i>
          <i class="cancel"></i>
          <i class="delete"></i>
        </td>
      </tr>
    </script>

    <script type="text/javascript">
      {# When we add a file, we create a new instance of the formset #}
      $('#add-file').click(function(){
        var count = $('#id_files-TOTAL_FORMS').attr('value');

        {# The first replace is some trickery to hide the formset delete checkbox #}
        {# The second replace is to update the formset ID, which will be used at save-time #}
        var compiledRowTemplate = $("#file-template").html().replace(/__prefix__-(DELETE|to_display)"/g, '__prefix__-$1" class="persist-hidden"').replace(/__prefix__/g, count);
        var compiledTemplate = $('#file-table-row-template').html().replace(/__form__/g, compiledRowTemplate);
        
        $('#file-table tbody').append(compiledTemplate);
        $('#id_files-TOTAL_FORMS').attr('value', parseInt(count, 10)+1);
      });

      {# This event-handling syntax is used because we're adding the target elements #}
      {# dynamically, so they don't exist on the DOM when the page runs #}
      $('#file-table').on('click', 'i.cancel', function(){
        var row = $(this).closest('tr');

        var inputFileName = row.find('[type="file"]').val();
        var inputFileDescription = row.find('#inputDescription').val();

        if(!inputFileName && !inputFileDescription && row.find('a').length === 0){
          row.find('.delete').click();
        } else{
          row.children().toggleClass('hidden');
        }
      });

      $('#file-table').on('click', 'i.delete', function(){
        var row = $(this).closest('tr');
        row.find('[id*=DELETE]').attr('checked', 'checked');
        row.addClass('hidden');
      });

      $('#file-table').on('click', 'i.file-hide', function(){
        var row = $(this).closest('tr');
        row.find('[id*=to_display]').removeAttr('checked');

        var hasChanged = row.find('span.initial-display').text() === 'True';

        {% if perms.uw_inventory.view_deleted_itemfile %}
          row.addClass('disabled');
          row.find('i.file-hide').remove();
          row.find('.file-menu').append('<i class="restore"></i>');
        {% else %}
          row.addClass('persist-hidden');
        {% endif %}

        $(window).trigger('pagechanges', hasChanged);
      });

      $('#file-table').on('click', 'i.restore', function(){
        var row = $(this).closest('tr');
        row.find('[id*=to_display]').attr('checked', 'checked');
        row.removeClass('disabled');
        row.find('i.restore').remove();
        row.find('.file-menu').append('<i class="file-hide"></i>');

        var hasChanged = row.find('span.initial-display').text() === 'False';
        $(window).trigger('pagechanges', hasChanged);
      });

      $('#file-table').on('click', 'i.save', function(){
        var row = $(this).closest('tr');
        var descriptionChanged = (row.find('#inputDescription').val() !== row.find('.default-description').text());
        var fileChanged = row.find('[type="file"]').val();
        if(row.find('[type="file"]').val()){
          var description = row.find('#inputDescription').val() ||
                        row.find('[type="file"]').val().formatFilename();

          {# Really horrible ugly filesize formatting #}
          var fileSize;
          try{
            fileSize = row.find('[type="file"]')[0].files[0].size;

            if(fileSize >= 1000000000){
              fileSize = (fileSize/1000000000).toFixed(2) + ' G';
            } else if(fileSize >= 1000000){
              fileSize = (fileSize/1000000).toFixed(2) + ' M';
            } else if(fileSize >= 1000){
              fileSize = (fileSize/1000).toFixed(2) + ' K';
            } else{
              fileSize = fileSize.toFixed(2) + ' ';
            }

            fileSize += 'B';
          } catch(e){ {# Exception arises if the browser doesn't support the HTML5 files API #}
            fileSize = 'N/A';
          }

          row.find('.file-description').html(description);
          row.find('.file-size').html(fileSize);
        }
        row.children().toggleClass('hidden');

        var hasChanged = descriptionChanged || fileChanged;
        if(hasChanged){
          row.addClass('warning');
        } else{
          row.removeClass('warning');
        }

        $(window).trigger('pagechanges', hasChanged);
      });

      $('#file-table').on('click', 'i.file-edit', function(){
        var row = $(this).closest('tr');
        row.children().toggleClass('hidden');
      });
    </script>
  {% endif %}

  {% if perms.uw_inventory.change_inventoryitem or perms.uw_inventory.add_inventoryitem %}
    <script type="text/javascript">
      {# We want to confirm user intent if they try to navigate away with unsaved changes #}
      var targetDestination;
      $('.navigate').parent().click(function(event){
        if(isPageDirty()){
          event.preventDefault();
          event.stopPropagation();
          targetDestination = event.target.href;
          $('#confirmExitModal').modal('show');
        }
      });

      $('#confirmExitModalContinue').click(function(){
        $('#confirmExitModal').modal('hide');
        window.location = targetDestination || {% url 'uw_inventory.views.inventory_list' %};
      });

      $('#confirmExitModalCancel').click(function(){
        $('#confirmExitModal').modal('hide');
      });
    </script>

    <script type="text/javascript">
      {# Manually define the autocomplete fields #}
      {# Doing it this way kind of hurts my soul, but I'm not sure Django's template #}
      {# system can handle iterating over array literals #}
      $('input#inputLocation').autocomplete({
        minLength: 1,
        source: "{% url 'uw_inventory.views.autocomplete_list' 'location' %}",
        select: function(event, ui){
          $('input#inputLocation').attr('to-save', ui.item.id)
        }
      });

      $('input#inputManufacturer').autocomplete({
        minLength: 1,
        source: "{% url 'uw_inventory.views.autocomplete_list' 'manufacturer' %}",
        select: function(event, ui){
          $('input#inputManufacturer').attr('to-save', ui.item.id)
        }
      });

      $('input#inputSupplier').autocomplete({
        minLength: 1,
        source: "{% url 'uw_inventory.views.autocomplete_list' 'supplier' %}",
        select: function(event, ui){
          $('input#inputSupplier').attr('to-save', ui.item.id)
        }
      });

      $('input#inputTechnician').autocomplete({
        minLength: 1,
        source: "{% url 'uw_inventory.views.autocomplete_list' 'technician' %}",
        select: function(event, ui){
          $('input#inputTechnician').attr('to-save', ui.item.id)
        }
      });

      $('input#inputOwner').autocomplete({
        minLength: 1,
        source: "{% url 'uw_inventory.views.autocomplete_list' 'owner' %}",
        select: function(event, ui){
          $('input#inputOwner').attr('to-save', ui.item.id)
        }
      });
    </script>
  {% endif %}

  {% if perms.uw_inventory.add_itemimage or perms.uw_inventory.change_itemimage %}
    <script type="text/html" id="image-detail-template">
    {% include 'uw_inventory/image_detail.html' with form=formsets.image.empty_form.as_p %}
    </script>
    <script type="text/javascript">
      $('#images-list').on('click', '.details', function(){
        $(this).closest('.image-item').find('.collapse').collapse('toggle');
        $(this).parent().children('.details').toggleClass('hidden');
      });

      $('#images-list').on('click', '.edit', function(){
        $(this).parent().children().toggleClass('hidden');
        $(this).closest('.image-item').find('.panel-body').children().toggleClass('hidden');
      });

      $('#images-list').on('click', '.cancel', function(){
        $(this).closest('.image-item').find('.panel-body').children().toggleClass('hidden');
        $(this).parent().children().toggleClass('hidden');
      });

      $('#images-list').on('click', '.delete', function(){
        $(this).closest('.image-item').find('[id*=to_display]').removeAttr('checked');
        $(this).addClass('hidden');
        $(this).siblings('.restore').removeClass('hidden');
        $(this).closest('.thumbnail').find('img').addClass('disabled');
        $(window).trigger('pagechanges', true);
      });

      $('#images-list').on('click', '.restore', function(){
        $(this).closest('.image-item').find('[id*=to_display]').attr('checked', 'checked');
        $(this).addClass('hidden');
        $(this).siblings('.delete').removeClass('hidden');
        $(this).closest('.thumbnail').find('img').removeClass('disabled');
        $(window).trigger('pagechanges', true);
      });

      $('#images-list').on('click', '.save', function(){
        var panelBody = $(this).closest('.panel').find('.panel-body');
        var newDescription = panelBody.find('#inputDescription').val();
        var newImageSrc = panelBody.find('[type="file"]').val();
        var oldImage = $(this).closest('.image-item').find('img');

        var hasChanged = (panelBody.find('p').text().trim() !== newDescription) || newImageSrc;
        panelBody.find('p').text(newDescription);

        $(this).parent().children().toggleClass('hidden');
        panelBody.children().toggleClass('hidden');

        $(window).trigger('pagechanges', hasChanged);
      });
    </script>
  {% endif %}
{% endblock js_includes %}