{% extends 'uw_inventory_system/base.html' %}
{% load uw_inventory_modal_tags %}

{% block css_includes %}
  <style type='text/css'>
    ul.errorlist li{
      list-style-type: none;
    }
    .field-hidden{
      display: none!important;
      visibility: hidden!important;
    }
    .ui-autocomplete {
      max-height: 100px;
      overflow-y: auto;
      /* prevent horizontal scrollbar */
      overflow-x: hidden;
    }
  </style>
  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/smoothness/jquery-ui.min.css">
{% endblock css_includes %}

{% block navbar_right %}
  <li>
    <button class="btn navbar-btn btn-success" id="pageSave">Save</button>
  </li>
  <li>
    <button class="btn navbar-btn btn-danger" id="pageCancel">Cancel</button>
  </li>
  {{ block.super }}
{% endblock navbar_right %}

{% block content %}
    <div class="row">
    <div class="col-xs-8 col-xs-offset-2">
      <div class="panel panel-default">
        <div class="panel-heading">{% block page_heading %}{% endblock page_heading %}</div>
            {% block page_body %}
            {% endblock page_body %}
        </div>
    </div>
  </div>
{% endblock content %}

{% block modal %}
  {% confirm_modal 'Exit' %}
  <div class="modal fade" id="autocompleteAddTermModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title"></h4>
        </div>
        <div class="modal-body">
          <form id="autocompleteAddTermForm">
            {% csrf_token %}
            <div class="form-group">
              <label for="termName">Name<span class="text-danger">*</span></label>
              <input type="text"
                     class="form-control"
                     id="autocompleteAddTermName"
                     name="termName"
                     placeholder="Name" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="autocompleteAddTermSubmit">Add option</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
{% endblock modal %}

{% block js_includes %}
  {# Need this for the date formatting on Edit page and for autocomplete widgets #}
  <script src="https://code.jquery.com/ui/1.11.2/jquery-ui.min.js"></script>

  <script type="text/javascript">
    $('a.autocomplete-add-term').click(function(event){
      $('#autocompleteAddTermName').val('');
      $('span.error').remove();
      $('#autocompleteAddTermName').parent().removeClass('has-error');

      var dataSet = event.target.getAttribute('data-set');
      $('#autocompleteAddTermModal').find('.modal-title')[0].textContent = "Add new " + dataSet;
      $('#autocompleteAddTermModal').modal().show();
    });

    $('#autocompleteAddTermSubmit').click(function(event){
      $('span.error').remove();
      $('#autocompleteAddTermName').parent().removeClass('has-error');

      var dataSet = $('a.autocomplete-add-term').attr('data-set');
      var optionName = $('#autocompleteAddTermName').val();

      if(optionName){
        $.ajax({
          url: '{% url "uw_inventory.views.autocomplete_new" %}',
          type: 'POST',
          data: $('#autocompleteAddTermForm').serialize() + "&dataSet=" + dataSet,
          success: function(data){
            if(data.error){
              $('#autocompleteAddTermName').parent().addClass('has-error');
              $('#autocompleteAddTermName').parent().append(
                '<span class="error text-danger">'+ data.error +'</span>'
              );
            } else {
              $('#autocompleteAddTermModal').modal().hide();
            }
          },
          error: function(xhr, err_msg, err){
            console.log(xhr);
            console.log(err_msg);
            console.log(err);
          }
        });
      } else {
        $('#autocompleteAddTermName').parent().append(
                '<span class="error text-danger">This field is required</span>'
              );
        $('#autocompleteAddTermName').parent().addClass('has-error');
      }
    });
  </script>

  <script type="text/javascript">
    $('i.checkbox').click(function(){
      if(!$(this).hasClass('hidden')){
        $(this).toggleClass('fa-square-o');
        $(this).toggleClass('fa-check-square-o');
        $(this).attr('value', $(this).hasClass('fa-check-square-o'))
      }
    });
  </script>
  <script type="text/javascript">
    {# Redirect on the cancel button #}
    $('#pageCancel').click(function(){
      window.location = {% url 'uw_inventory.views.inventory_list' %};
    });
  </script>

  <script type="text/javascript">
    {# We want to confirm user intent if they try to navigate away with unsaved changes #}
    var pageDirty = false;
    var targetDestination;
    $('.navigate').parent().click(function(event){
      if(pageDirty){
        event.preventDefault();
        event.stopPropagation();
        targetDestination = event.target.href;
        $('#confirmExitModal').modal('show');
      }
    });

    $('#confirmExitModalContinue').click(function(){
      $('#confirmExitModal').modal('hide');
      window.location = targetDestination || {% url 'uw_inventory.views.inventory_list' %};
    });

    $('#confirmExitModalCancel').click(function(){
      $('#confirmExitModal').modal('hide');
    });
  </script>

  <script type="text/javascript">
    $(function(){
      var cache = {};
      $('input#inputLocation').autocomplete({
        minLength: 1,
        source: "{% url 'uw_inventory.views.autocomplete_list' 'location' %}",
        select: function(event, ui){
          $('input#inputLocation').attr('to-save', ui.item.id)
        }
      });
    });
    $(function(){
      var cache = {};
      $('input#inputManufacturer').autocomplete({
        minLength: 1,
        source: "{% url 'uw_inventory.views.autocomplete_list' 'manufacturer' %}",
        select: function(event, ui){
          $('input#inputManufacturer').attr('to-save', ui.item.id)
        }
      });
    });
  </script>
{% endblock js_includes %}