{% extends 'uw_forms/form_base.html' %}

{% block page_content %}
  <div class="row">
    <div class="btn-toolbar">
      <div class="btn-group btn-group-sm">
        <button class="btn btn-primary" id="add-expression">Add Expression</button>
      </div>
      <div class="btn-group btn-group-sm" id="expression-operator-list">
        <button class="btn btn-default disabled" id="add-and">AND</button>
        <button class="btn btn-default disabled" id="add-or">OR</button>
      </div>
      <div class="btn-group btn-group-sm">
        {# <button class="btn btn-default" id="add-lparen">(</button> #}
        {# <button class="btn btn-default" id="add-rparen">)</button> #}
      </div>
    </div>
  </div>

  <div class="row">
    <table class="table table-condensed" id="query-table">
      <thead class="persist-hidden">
        <td>Negation</td>
        <td>Field</td>
        <td>Lookup</td>
        <td>Filter Value</td>
        <td>Menu</td>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>

  <form action="{% url 'uw_reports.views.create_report' %}"
      method="post"
      class="hidden"
      id="report-form">
    {{ form.as_p }}
  </form>
{% endblock page_content %}

{% block js_includes %}
  <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

  <script type="text/html" id="expression-row-template">
    <tr class="expression">
      <td><label><input type="checkbox" class="expression-negate" /> Not</label></td>
      <td class="expression-field">
        <select class="form-control">
          <option value="">------</option>
          {% for field in field_list %}
            <option data-type="{{ field.type }}">{{ field.Name }}</option>
          {% endfor %}
        </select>
      </td>
      <td class="expression-lookup">
        <select class="form-control" disabled="disabled">
          <option class="blank"></option>          
          <option value="exact" class="hidden text bool case">Is Exactly</option>
          <option value="contains" class="hidden text case">Contains</option>
          <option value="startswith" class="hidden text case">Starts With</option>
          <option value="endswith" class="hidden text case">Ends With</option>
          <option value="in" class="hidden text number list">In List</option>          
          <option value="range" class="hidden text number range">In Range</option>
          <option value="gt" class="hidden text number">Greater Than</option>
          <option value="gte" class="hidden text number">Greater Than or Equal To</option>
          <option value="lt" class="hidden text number">Less Than</option>
          <option value="lte" class="hidden text number">Less Than or Equal To</option>
          <option value="year" class="hidden date">In Year</option>
          <option value="month" class="hidden date choice" data-choices="months">In Month</option>
          <option value="day" class="hidden date">On Day of Month</option>
          <option value="week_day" class="hidden date choice" data-choices="weekdays">On Day of Week</option>
          <option value="isnull" class="hidden text date number bool">Has a Value</option>
        </select>
        <label class="hidden case-sensitive"><input type="checkbox" /> Case-sensitive?</label>
      </td>
      <td class="expression-input"><input type="text" class="form-control" disabled="disabled" /></td>
      <td class="expression-filter"></td>
      <td class="expression-menu">
        {#<i class="fa-arrow-up"></i>#}
        {#<i class="fa-arrow-down"></i>#}
        <i class="cancel"></i>
      </td>
    </tr>
  </script>

  <script type="text/html" id="expression-cond-template">
    <tr class="condition-__cond__">
      <td colspan="5">__cond__</td>
      <td class="expression-cond-menu">
        <i class="fa-arrow-up"></i>
        <i class="fa-arrow-down"></i>
      </td>
    </tr>
  </script>

  <script type="text/html" id="expression-paren-template">
    <tr class="__dir__-paren">
      <td><label><input type="checkbox" class="expression-negate" /> Not</label></td>
      <td colspan="4">__paren__</td>
      <td class="expression-cond-menu">
        {#<i class="fa-arrow-up"></i>#}
        {#<i class="fa-arrow-down"></i>#}
        <i class="cancel"></i>
      </td>
    </tr>
  </script>

  <script type="text/html" id="input-range-template">
    <input class="form-control" type="__type__" /> To <input class="form-control" type="__type__" />
  </script>

  <script type="text/html" id="input-input-template">
    <input class="form-control" type="__type__" />
  </script>

  <script type="text/html" id="input-bool-template">
    <select class="form-control">
      <option></option>
      <option value="true">Yes</option>
      <option value="false">No</option>
    </select>
  </script>



  <script type="text/javascript">
    $('#add-expression').on('statechange', function(){
      if($('#query-table tbody tr').length === 1 && $('#expression-operator-list button.active').length === 0){
        $('#add-expression').addClass('disabled');
        $('#expression-operator-list button').removeClass('disabled');
      } else if($('#query-table tbody tr').length === 0){
        $('#add-expression').removeClass('disabled');
        $('#expression-operator-list button').removeClass('active').addClass('disabled');
      } else{
        $('#add-expression').removeClass('disabled');
      }
    });

    $('#add-expression').click(function(){
      var toAppend = '';
      if($('#add-and').is('.active')){
        toAppend = $('#expression-cond-template').html().replace(/__cond__/g, 'AND');
      } else if($('#add-or').is('.active')){
        toAppend = $('#expression-cond-template').html().replace(/__cond__/g, 'OR');
      }
      
      $('#query-table tbody').append(toAppend + $('#expression-row-template').html());
      $(this).trigger('statechange');
    });

    var openExpressions = 0;
    $('#add-lparen').click(function(){
      $('#query-table tbody').append($('#expression-paren-template').html().replace(/__dir__/g, 'left').replace(/__paren__/g, '('));
      openExpressions++;
    });

    $('#add-rparen').click(function(){
      $('#query-table tbody').append($('#expression-paren-template').html().replace(/__dir__/g, 'right').replace(/__paren__/g, ')'));
      openExpressions--;
    });

  </script>

  <script type="text/javascript">
    $('#expression-operator-list button').click(function(){
      $(this).toggleClass('active');
      $(this).siblings().removeClass('active');

      $('#add-expression').trigger('statechange');
    });
  </script>


  <script type="text/javascript">
    $('#query-table tbody').on('change', '.expression-field', function(){
      var selectedFieldType = $(this).find('option:selected').attr('data-type');

      $(this).closest('tr').find('td.expression-lookup select').val('');
      $(this).closest('tr').find('td.expression-lookup select option:not(.blank)').addClass('hidden');
      $(this).closest('tr').find('td.expression-lookup .case-sensitive').addClass('hidden');

      if(selectedFieldType === 'choice'){
        $(this).closest('tr').find('td.expression-lookup select option[value="exact"],option[value="isnull"],option[value="in"]').removeClass('hidden');
      } else {
        $(this).closest('tr').find('td.expression-lookup select option.' + selectedFieldType).removeClass('hidden');
      }

      if($(this).find('select').val()){
        $(this).closest('tr').find('td.expression-lookup select').removeAttr('disabled');
      } else{
        $(this).closest('tr').find('td.expression-input').html(
          $('#input-input-template').html().replace(/__type__/g, 'text')
        );
        $(this).closest('tr').find('td.expression-input input').attr('disabled', 'disabled');
        $(this).closest('tr').find('td.expression-lookup select').attr('disabled', 'disabled');
      }
    });

    $('#query-table tbody').on('change', '.expression-lookup', function(){
      var selectedOption = $(this).find('option:selected');
      var selectedFieldType = $(this).closest('tr').find('.expression-field select').find('option:selected').attr('data-type');

      if(selectedOption.is('.case') && !(selectedFieldType === 'bool' || selectedFieldType === 'choice')){
        $(this).closest('tr').find('.case-sensitive').removeClass('hidden');
      } else{
        $(this).closest('tr').find('.case-sensitive').addClass('hidden');
      }

      var inputWidget;
      if(selectedOption.is('.range')){
        inputWidget = $('#input-range-template').html().replace(/__type__/g, selectedFieldType);
      } else if(selectedFieldType === 'choice'){
        var options = selectedOption.is('[value="in"]') ? '' : '<option></option>';

        $.each({{ choice_fields.status|safe }}, function(key, val){
          options += '<option value="' + key + '">' + val + '</option>';
        });

        if(selectedOption.is('[value="in"]')){
          inputWidget = '<select class="form-control" multiple="multiple">' + options + '</select>';
        } else {
          inputWidget = '<select class="form-control">' + options + '</select>';
        }
      } else if(selectedOption.is('.bool')){
        inputWidget = $('#input-bool-template').html();
      } else if(selectedOption.attr('value') === 'day'){
        inputWidget = $('#input-input-template').html().replace(/__type__/g, 'number');
      } else if(selectedOption.is('.choice')){
        var options = '<option></option>';
        var optionsArr;
        switch(selectedOption.attr('data-choices')){
          case 'months':
            optionsArr = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
            break;
          case 'weekdays':
            optionsArr = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            break;
        }
        $.each(
          optionsArr,
          function(idx, val){
            options += '<option value="' + idx + '">' + val + '</option>';
          }
        );
        inputWidget = '<select class="form-control">' + options + '</select>';
      } else {
        if(selectedOption.is('.list')){
          inputWidget = $('#input-input-template').html().replace(/__type__/g, 'text');
        } else {
          inputWidget = $('#input-input-template').html().replace(/__type__/g, selectedFieldType);
        }
      }

      $(this).closest('tr').find('.expression-input').html(inputWidget);
    });

    $('#query-table tbody').on('click', '.expression-menu .cancel', function(){
        var lsibling = $(this).closest('tr').prev();
        var rsibling = $(this).closest('tr').next();

        console.log(!!rsibling)

        if(lsibling.length > 0 && lsibling.is('.condition-AND')){
          lsibling.remove();
        } else if(rsibling.length > 0 && rsibling.is('.condition-AND')){
          rsibling.remove();
        } else if(lsibling.length > 0){
          lsibling.remove();
        } else if(rsibling.length > 0){
          rsibling.remove();
        }

      $(this).closest('tr').remove();
      $('#add-expression').trigger('statechange');
    });
  </script>


  <script type="text/javascript">
    $('#pageSave').click(function(){
      $('#report-form').submit();
    });
  </script>
{% endblock js_includes %}